FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    python3 \
    python3-pip \
    python3-venv \
    google-perftools \
    bc \
    libgl1-mesa-glx \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    ffmpeg \
    python3-opencv \
    wget \
    sudo \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Create a non-root user
RUN useradd -m -u 1000 sduser

# Create app directory with very permissive permissions
WORKDIR /home/sduser/app
RUN chown -R sduser:sduser /home/sduser && chmod 777 /home/sduser/app

# Clone Stable Diffusion WebUI as sduser
USER sduser
RUN git clone https://github.com/AUTOMATIC1111/stable-diffusion-webui.git .

# Create and activate virtual environment
RUN python3 -m venv /home/sduser/app/venv
ENV PATH="/home/sduser/app/venv/bin:$PATH"

# Install torch and other dependencies
RUN pip install torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/cu118

# Switch back to root for entrypoint
USER root
COPY sd-entrypoint.sh /home/sduser/app/sd-entrypoint.sh
RUN chmod +x /home/sduser/app/sd-entrypoint.sh

EXPOSE 7860

ENTRYPOINT ["/home/sduser/app/sd-entrypoint.sh"]